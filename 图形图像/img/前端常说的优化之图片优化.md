首先要说的是，关于图片的编码原理，压缩算法这些都是很专业的领域，对于前端来讲，知道一般的应用场景和一般的特性就可以了。

# 优化原则：

下面是我总结的一些优化原则：

-   能不使用就不使用，比如可以用 CSS 和 iconfont 代替
-   适合用矢量图，就用矢量图
-   尽量使用小尺寸图片
-   能用 PNG8 不用 PNG24 / PNG32
-   能用 WebP 就用 WebP
-   非动画场景不使用 GIF

体验优化：

-   交错模式
-   渐进式处理
-   懒加载

## 基本概念

### 矢量图与栅格图像

-   矢量图：形使用线、点和多边形来表示图像。
-   栅格图像： 通过对矩形格栅内的每个像素的值进行编码来表示图像。

矢量图： 前端最常见的矢量图是 SVG。关于 SVG 基础看这里 【#### SVG 链接 ####】， SVG 适用于包含简单的几何图形的图像，因为 SVG 缩放不失真，所以 SVG 最适合用于高分辨率屏幕和需要以不同尺寸显示的图像。

栅格图像：

-   由一个个的像素栅格组成
-   每个像素都编码了颜色和透明度信息
-   使用不用的压缩算法（不同的图片格式），以减小图像的文件大小。

以为源数据太大，一般在网页中使用的是经过压缩的文件，下面是一个 JPG 文件的压缩和解压的过程：
![jpg 编码与解码](https://raw.githubusercontent.com/XiangnianZhou/blog/master/%E5%9B%BE%E5%BD%A2%E5%9B%BE%E5%83%8F/img/images/jpg-c-dec.png)

这里涉及两个过程：

-   编码： 源数据编码得到 JPG 文件；这个 JPG 文件，用于存储和出传输。
-   解码： 要显示这个图像的时候，解码 JPG 文件内容得到源数据。

### 有损压缩无损压缩

继续以上面的 JPG 编解码为例。源数据是**2 维“像素”栅格**，比如，一个 10 × 10 的图像便有 100 个像素。每个像素又存储了 RGBA 的值： (R) 红色通道、(G) 绿色通道、(B) 蓝色通道和 (A) alpha（透明度）通道。每个通道 8 位，即每个像素 4 个字节。
浏览器在拿到 jpg 文件之后，解码得到一个同原始数据一样的像素栅格序列，也要为每个像素分配 4 个字节的内存（无论使用什么格式传输，最后还原数据会和原始数据一样大）。

那么， 如果浏览器可以解码得到原始数据，则为**无损压缩**。如果为了得到更小的文件，压缩过程中可能会丢弃一些人眼不能察觉的信息，而且这个过程是不可逆的，那么浏览器解码也就无法得到原始数据，这种压缩方式便是**有损压缩**。

对于栅格图像要根据不同的使用场景选择合适格式，接下来探究一些常见的这几种图片格式。

# 常见图片个格式

## JPG/JPEG

可能是目前世界上使用最广泛的图像格式。

### 特点：

-   不支持透明；
-   有损压缩。

JPG 适合于色彩丰富，线条感比较弱的图片，比如大的背景图，banner 图等等。JPG 是有损压缩，压缩时质量级别越低体积越小，图片也越模糊。所以，在使用时，需要根据需要选择合适的质量级别。

### 优化
JPEG 有多种不同的压缩模式， 比如常见的基线（顺序）和渐进式 JPEG (PJPEG)。

基线 JPEG（大多数图像编辑和优化工具的默认设置）以相对简单的方式进行编码和解码：从上到下。 在连接速度缓慢或不稳定的情况下加载基线 JPEG 时，用户会先看到图像的顶部，然后随着图像加载逐渐看到图像的其他部分。 
盗用谷歌图：

![jpg baseline](https://raw.githubusercontent.com/XiangnianZhou/blog/master/%E5%9B%BE%E5%BD%A2%E5%9B%BE%E5%83%8F/img/images/jpg-baseline.jpg)

基线 JPEG 的加载方式是从上到下，而渐进式 JPEG 是从模糊到清晰。

渐进式 JPEG 将图像分成多次扫描， 第一次扫描以模糊或低质量设置显示图像，后续扫描逐步提高图像质量。 我们可以将这个过程看作“渐进式”提高图像质量。 每次“扫描”图像都会增加图像细节的清晰程度， 最后合并为全画质图像。

![jpg progressive](https://raw.githubusercontent.com/XiangnianZhou/blog/master/%E5%9B%BE%E5%BD%A2%E5%9B%BE%E5%83%8F/img/images/jpg-progressive.jpg)


渐进式 JPEG 可以在没有下载完图片就可以看到最终图像的大致轮廓，一定程度上可以提升用户体验。

与基线 JPEG相比，渐进式 JPEG:
- 比较大的图，有更高压缩率；
- 需要更多的CPU资源去解码。

使用基线 JPEG相比还是渐进式 JPEG，需要我们根据场景选择，在文件大小，网络延迟和CPU消耗之间做一个权衡。

--------
关于渐进式 JPEG 扯点别的：
渐进式 JPEG 采用的扫描算法有个学名 -- 隔行扫描，更多信息请看 [维基百科](https://en.wikipedia.org/wiki/Interlacing_(bitmaps))的介绍。

隔行扫描的效果是下面这样的，这图感觉专业而且很形象：

![Interlacing](https://upload.wikimedia.org/wikipedia/commons/2/27/Adam7_passes.gif)

除了 JPEG 可以支持隔行扫描外，PNG 和 GIF 也有支持，便是交错式 PNG\GIF。

### 优缺点

优点：

-   使用高效的压缩算法，图片体积小；
-   色彩丰富，可以支持 24bit 真彩色；
-   压缩的质量级别可以控制。

缺点：
对于线条感较强，颜色对比强烈的图，JPG 的压缩通常会更易让人感觉到模糊；另外对于有透明度要求的图 JPG 完全无能为力，这个时候我们就要考虑 PNG 了。

## PNG

### 特点：

-   支持透明；
-   除了选择调色板的大小外，PNG 不采用任何有损压缩算法。

因为 PNG 是一种无损压缩的高保真的图片格式（调色板大小的问题，下面讨论），所以，可以保存更多的细节，同时体积也就更大。

### 优化

既然 PNG 是无损压缩为什么一些工具还声称可以压缩 PNG 呢？比如最知名的 [tinypng（也有人称为熊猫网）](https://tinypng.com/)。

看看 tinypng 官网在说的：

> ### How does it work?
>
> Excellent question! When you upload a PNG (Portable Network Graphics) file, similar colors in your image are combined. This technique is called “quantization”. By reducing the number of colors, 24-bit PNG files can be converted to much smaller 8-bit indexed color images. All unnecessary metadata is stripped too. The result better PNG files with 100% support for transparency. Have your cake and eat it too!

这儿需要铺垫一下 PNG 的三种形式：PNG8，PNG24 和 PNG32。
PNG8 和 PNG24 主要的区别有：

-   最直观的的就是颜色位数的不同。每个像素点的数据，PNG8 需要 8 位即一个字节，而 PNG24 使用 24 位也就是三个字节， RGB 三个通道个需一个字节。
-   因为位数不同，能表示的颜色数量不同。PNG8 最多只能表示 256 色，而 PNG24 支持 24 位真彩色。
-   压缩方式不同。PNG8 采用调色板存储颜色 + 索引值的方式，PNG24 无调色板，使用点阵存储色值。
-   半透明支持不同。PNG8 调色板中每种颜色使用 RGBA 四通道表示，支持 半透明，而 PNG24 每个像素只有 RGB 三通道，所以 PNG24 不支持半透明。

PNG24 与 PNG32：

-   PNG32 相比 PNG24 多了一个 Alpha 通道，支持半透明。
-   很多时候不区分 PNG24 和 PNG32。比如 PS 中，只有 PNG24 的选项，如果勾选了透明选项则是表示是 PNG32。

我们回过头继续说 PNG 的优化，正如 tinypng 官网所说，他们采用的优化便是把 PNG24/PNG32 转为 PNG8。这种优化方式也成为**PNG 的有损压缩**。

平常使用中一般选择使用 PNG8，如果 PNG8 的效果太差，则建议改为使用其他格式，因为 PNG24 会大很多。

PNG 还有一个上文提到过的优化策略　－－　**交错式 PNG**， 和渐进式 JPEG 的效果和原理相同，这里就不过多介绍了。

# GIF

与 PNG8 的比较：

-   不支持 alpha 透明
-   除非很小的图，PNG8 的体积小于 GIF

## SVG

关于 SVG 基础看这里 【#### SVG 链接 ####】
使用 AI 和 Sketch 中导出的 SVG 包含大量元数据，例如图层信息、注解和 XML 命名空间，这些在浏览器中都是不需要的。因此使用一些工具可以去掉这些没有必要的信息。
另外，因为 SVG 是文本文件，所以要使用 GZIP 进行压缩。

###
